<!-- app/views/api/v1/troubleshooting/index.html.erb -->

<div class="max-w-7xl mx-auto space-y-8">

  <!-- Search-Based Error Selection -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center">
        <span class="text-red-600 text-xl">âš </span>
      </div>
      <div>
        <h3 class="text-xl font-semibold text-gray-800">System Diagnostics</h3>
        <p class="text-gray-600 text-sm">Type to search for an error type and begin troubleshooting</p>
      </div>
    </div>

    <%= form_with url: troubleshoot_path, method: :post, remote: true, id: "troubleshoot_form", class: "space-y-4" do |form| %>

      <!-- Search Box -->
      <div>
        <%= form.label :error_type_search, "Search Error Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_field :error_type_search, id: "error_search", autocomplete: "off",
            class: "block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500" %>
        <ul id="search_results" class="mt-2 border border-gray-200 rounded-lg bg-white shadow-sm max-h-60 overflow-y-auto hidden"></ul>
      </div>

      <!-- Hidden radio buttons (for form submission) -->
      <% error_options = {
        'Database Issues' => { 'db_connection' => 'Connection Failed', 'db_migration' => 'Migration Errors', 'db_timeout' => 'Query Timeout' },
        'Network Issues' => { 'api_timeout' => 'API Timeout', 'ssl_cert' => 'SSL Certificate', 'dns_resolution' => 'DNS Resolution' },
        'Synchronization Issues' => { 'routing_error' => 'Routing Errors', 'asset_compilation' => 'Asset Compilation', 'dependency_error' => 'Dependency Issues' },
        'Authentication Issues' => { 'login_failed' => 'Login Failures', 'session_timeout' => 'Session Timeout', 'permission_denied' => 'Permission Denied' }
      } %>

      <% error_options.each do |category, errors| %>
        <% errors.each do |key, label| %>
          <%= form.radio_button :error_type, key, id: key, class: "hidden" %>
        <% end %>
      <% end %>

      <!-- Action Buttons -->
      <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
        <%= form.submit "Start Troubleshooting", 
            class: "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed",
            id: "troubleshoot_btn",
            disabled: true %>

        <button type="button" id="clear_selection" 
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition-all duration-200">
          Clear Selection
        </button>

        <div class="flex items-center gap-2 text-sm text-gray-500 ml-auto">
          <div class="w-2 h-2 rounded-full bg-gray-400" id="status_indicator"></div>
          <span id="status_text">Select an error type to begin</span>
        </div>
      </div>

    <% end %>
  </div>
    <!-- Troubleshooting Result -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 space-y-6">
    <div class="flex items-center gap-4">
        <!-- Unicode Terminal/Output Icon -->
        

        <div class="flex-1">
        <h3 class="text-2xl font-semibold text-gray-800 mb-2">Output</h3>

        <% if @result.present? %>
            <% result_class = @result.downcase.include?("error") ? 
                "bg-red-50 border-red-300 text-red-700" : 
                "bg-green-50 border-green-300 text-green-700" %>

            <div class="p-4 rounded-lg border <%= result_class %> shadow-sm">
            <strong class="block mb-1">Result:</strong>
            <span class="whitespace-pre-line"><%= @result %></span>
            </div>
        <% else %>
            <p class="text-gray-500 italic">No result available.</p>
        <% end %>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="space-y-3" id="recent_activity">
        <!-- Dynamically filled -->
    </div>
    </div>

<style>
#search_results li:hover { background-color: #e0f2fe; cursor: pointer; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('error_search');
  const searchResults = document.getElementById('search_results');
  const troubleshootBtn = document.getElementById('troubleshoot_btn');
  const clearBtn = document.getElementById('clear_selection');
  const radioButtons = document.querySelectorAll('input[type="radio"]');

  const errorMap = {
    'resolve_sync_credentials': 'Resolve Credentials',
    'resolve_sync_configs': 'Resolve Sync Configs',
  };

  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    searchResults.innerHTML = '';
    if (!query) { searchResults.classList.add('hidden'); return; }

    Object.entries(errorMap).forEach(([key, label]) => {
      if (label.toLowerCase().includes(query)) {
        const li = document.createElement('li');
        li.textContent = label;
        li.className = "px-3 py-2 text-sm text-gray-700";
        li.addEventListener('click', () => {
          radioButtons.forEach(r => r.checked = r.id === key);
          troubleshootBtn.disabled = false;
          searchInput.value = label;
          searchResults.classList.add('hidden');
        });
        searchResults.appendChild(li);
      }
    });

    searchResults.classList.toggle('hidden', searchResults.children.length === 0);
  });

  clearBtn.addEventListener('click', function() {
    searchInput.value = '';
    searchResults.innerHTML = '';
    radioButtons.forEach(r => r.checked = false);
    troubleshootBtn.disabled = true;
  });
});
</script>